<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>刚才</title>
    <link rel="manifest" href='data:application/manifest+json,{"name":"刚才","short_name":"刚才","display":"standalone","start_url":".","background_color":"#F5EBE0","theme_color":"#81B29A"}'>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap');
        :root { --m-bg: #F5EBE0; --m-sage: #81B29A; --m-clay: #E07A5F; --m-text: #3D405B; }
        body { font-family: 'Outfit', 'PingFang SC', sans-serif; background-color: var(--m-bg); color: var(--m-text); transition: background-color 0.8s ease; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { display: none; }
        
        /* 引导层隔离系统 */
        #tour-overlay { position: fixed; inset: 0; z-index: 9990; background: rgba(0,0,0,0.7); display: none; pointer-events: auto; }
        #tour-bubble { position: fixed; z-index: 9995; background: white; padding: 24px; border-radius: 32px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 240px; display: none; pointer-events: none; }
        .tour-highlight-area { position: relative; z-index: 9991 !important; background: white !important; box-shadow: 0 0 0 10px white, 0 0 0 5000px rgba(0,0,0,0.7) !important; border-radius: 12px !important; pointer-events: none !important; }

        #app-splash { position: fixed; inset: 0; z-index: 10000; background: var(--m-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; pointer-events: none; }
        #app-onboarding { position: fixed; inset: 0; z-index: 8000; background: rgba(245, 235, 224, 0.98); display: none; padding: 40px; flex-direction: column; justify-content: center; text-align: center; }
        
        .morandi-card { background: rgba(255, 255, 255, 0.4); border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.5); }
        .picker-box { height: 90px; display: flex; mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent); }
        .picker-col { flex: 1; height: 90px; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .picker-item { height: 30px; display: flex; align-items: center; justify-content: center; scroll-snap-align: center; font-size: 13px; color: #d1d5db; transition: 0.2s; }
        .picker-item.selected { color: var(--m-sage); font-weight: 700; font-size: 15px; }
        
        .nav-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.02); }
        .page { display: none; animation: pageFade 0.4s ease forwards; }
        .page.active { display: block; }
        @keyframes pageFade { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-tag { padding: 10px 18px; border-radius: 18px; background: white; font-size: 13px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .btn-tag.active { background: var(--m-sage); color: white; transform: scale(0.95); }
        .pill-toggle { background: white; padding: 6px 14px; border-radius: 99px; border: 1px solid rgba(129, 178, 154, 0.3); display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }

        #stats-menu { position: fixed; inset: 0; z-index: 9400; background: rgba(0,0,0,0.1); display: none; }
        .stats-dropdown { position: absolute; top: 110px; left: 32px; background: white; border-radius: 28px; padding: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 220px; }
        .menu-item { padding: 12px 16px; font-size: 13px; font-weight: 600; border-radius: 14px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .menu-item.active { color: var(--m-sage); background: #f0f8f4; }

        /* 紧凑轨迹流 */
        .timeline-line { position: absolute; left: 89px; top: 0; bottom: 0; width: 1px; background: rgba(129, 178, 154, 0.2); }
        .history-card { background: white; padding: 10px 14px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); width: 100%; }

        #cal-modal { position: fixed; inset: 0; z-index: 9800; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: 20px; }
        .cal-box { background: white; width: 100%; max-width: 310px; border-radius: 32px; padding: 24px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-radius: 50%; color: #999; cursor: pointer; }
        .cal-day.selected { background: var(--m-sage); color: white !important; }

        input[type="range"] { -webkit-appearance: none; background: rgba(0,0,0,0.05); height: 4px; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--m-clay); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="pb-24">

    <!-- 启动页 -->
    <div id="app-splash"><div class="w-16 h-16 rounded-3xl bg-white shadow-xl flex items-center justify-center mb-4"><span class="text-2xl font-bold text-[#81B29A]">刚</span></div><h2 class="text-[10px] font-bold tracking-[0.3em] text-stone-400 uppercase">Just Now</h2></div>
    
    <!-- 引导 -->
    <div id="tour-overlay" onclick="nextStep()"></div>
    <div id="tour-bubble"><p id="tour-txt" class="text-xs leading-relaxed text-stone-600 mb-4 font-medium"></p><div class="flex justify-between items-center text-[9px] font-black uppercase text-[#81B29A] tracking-widest"><span id="tour-num">1/5</span><span>点击任意处继续</span></div></div>
    
    <!-- 寄语 -->
    <div id="app-onboarding"><div class="max-w-xs mx-auto space-y-8"><h3 class="text-xl font-bold italic text-stone-700">你好呀，很高兴遇见你。</h3><p class="text-sm leading-relaxed text-stone-500 font-light">时间不是流沙，而是生活的颗粒。<br>在这里，我们学习柳比歇夫——<br><b>不评价，只记录。</b><br><br>准备好开始探索自己了吗？</p><button onclick="finishOnboarding()" class="w-full py-4 bg-[#3D405B] text-white rounded-full font-bold text-xs tracking-[0.2em]">开启记录之旅</button></div></div>

    <!-- 顶栏 -->
    <header class="p-8 pb-0 flex justify-between items-start">
        <div id="title-area" class="flex items-baseline space-x-2">
            <h1 id="main-h1" class="text-3xl font-bold tracking-tighter">刚才</h1>
            <span id="sub-h1" class="text-sm font-medium text-stone-400">做了什么呢</span>
        </div>
        <div id="date-action-area">
            <button onclick="openCal()" class="pill-toggle !text-[10px] !py-1 !px-3" id="tour-date-target">
                <span id="header-date-str" class="!font-black">--月--日</span>
                <i data-lucide="chevron-down" class="w-3 h-3 opacity-30"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-6 mt-6">
        <!-- 页面 1: 记录 -->
        <div id="page-record" class="page active space-y-8">
            <div class="morandi-card p-6 shadow-sm" id="tour-time-target">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <span class="text-[9px] font-bold text-stone-300 uppercase tracking-widest mb-1 block">起始点</span>
                        <div class="picker-box"><div id="h-start" class="picker-col"></div><div id="m-start" class="picker-col"></div></div>
                        <span id="hint-yesterday" class="text-[8px] text-m-clay font-bold opacity-0 transition-opacity">前一日</span>
                    </div>
                    <div class="text-center border-l border-white/50">
                        <span class="text-[9px] font-bold text-stone-300 uppercase tracking-widest mb-1 block">结束点</span>
                        <div class="picker-box"><div id="h-end" class="picker-col"></div><div id="m-end" class="picker-col"></div></div>
                        <span class="text-[8px] text-stone-200">（不可选未来）</span>
                    </div>
                </div>
            </div>
            <div class="space-y-4" id="tour-tag-target"><div id="tagBox" class="flex flex-wrap gap-2"></div><input id="otherInp" type="text" placeholder="描述细节..." class="hidden w-full p-4 rounded-2xl bg-white/60 border-none text-sm outline-none"></div>
            <div class="space-y-6"><div class="flex justify-between items-end px-1"><label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">此刻状态</label><span id="vibeLabel" class="text-[11px] font-bold text-stone-500 bg-white/40 px-3 py-1 rounded-full">平静如水</span></div><input type="range" id="vibeRange" min="1" max="5" step="1" value="3" class="w-full"></div>
            <button onclick="saveRecord()" class="w-full bg-[#3D405B] text-white py-5 rounded-[26px] font-bold shadow-lg active:scale-95 transition text-sm tracking-[0.2em]">存入这一刻</button>
        </div>

        <!-- 页面 2: 今天 -->
        <div id="page-history" class="page space-y-4">
            <div class="relative min-h-[300px]">
                <div class="timeline-line"></div>
                <div id="history-flow" class="space-y-2 relative pt-2"></div>
            </div>
        </div>

        <!-- 页面 3: 统计 -->
        <div id="page-stats" class="page space-y-6">
            <div class="morandi-card p-8 text-center space-y-4 shadow-sm">
                <i data-lucide="sparkles" class="w-6 h-6 mx-auto text-stone-300"></i>
                <h3 class="text-sm font-bold">镜像叙事报告</h3>
                <p id="reportContent" class="text-[11px] text-stone-600 leading-relaxed italic px-4 font-serif">记录是看见自己的第一步。</p>
                <button onclick="getAIReport()" class="bg-[#3D405B] text-white px-8 py-2.5 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg">生成信件</button>
            </div>
            <div id="tour-stats-target" class="morandi-card p-6 shadow-sm"><div id="distList" class="space-y-4"></div></div>
        </div>

        <!-- 页面 4: 设置 -->
        <div id="page-settings" class="page space-y-6">
            <div class="space-y-4"><label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest pl-1">常做事项</label><div id="settingTags" class="grid grid-cols-1 gap-2"></div></div>
            <div class="space-y-4"><label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest pl-1">DeepSeek API Key</label><input id="apiKeyInp" type="password" class="w-full p-4 rounded-2xl bg-white border-none text-sm outline-none shadow-sm"></div>
            <button onclick="applySettings()" class="w-full bg-stone-400 text-white py-4 rounded-[22px] text-[11px] font-bold uppercase tracking-widest">保存并同步</button>
            <div class="pt-10 flex justify-center opacity-20"><button onclick="if(confirm('注销所有记忆？')){localStorage.clear();location.reload();}" class="text-[10px] underline">清空数据</button></div>
        </div>
    </main>

    <!-- 底部导航 -->
    <nav class="nav-glass fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center px-6 pb-4">
        <button onclick="goTab('record')" class="n-btn text-stone-300" id="btn-record"><i data-lucide="plus-circle" class="w-6 h-6"></i></button>
        <button onclick="goTab('history')" class="n-btn text-stone-300" id="btn-history"><i data-lucide="layout-list" class="w-6 h-6"></i></button>
        <button onclick="goTab('stats')" class="n-btn text-stone-300" id="btn-stats"><i data-lucide="sparkles" class="w-6 h-6"></i></button>
        <button onclick="goTab('settings')" class="n-btn text-stone-300" id="btn-settings"><i data-lucide="fingerprint" class="w-6 h-6"></i></button>
    </nav>

    <!-- 统计菜单与日历 -->
    <div id="stats-menu" onclick="this.style.display='none'"><div class="stats-dropdown" onclick="event.stopPropagation()"><div class="p-2 border-b border-stone-50 mb-2 flex space-x-1"><button onclick="setStatsDim('week')" id="dim-week" class="flex-1 py-1.5 rounded-xl text-[10px] font-bold">按周</button><button onclick="setStatsDim('month')" id="dim-month" class="flex-1 py-1.5 rounded-xl text-[10px] font-bold">按月</button><button onclick="setStatsDim('year')" id="dim-year" class="flex-1 py-1.5 rounded-xl text-[10px] font-bold">按年</button></div><div id="menu-options-list" class="menu-list max-h-[200px] overflow-y-auto"></div></div></div>
    <div id="cal-modal" onclick="this.style.display='none'"><div class="cal-box" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><button onclick="stepMonth(-1)"><i data-lucide="chevron-left"></i></button><h4 id="cal-title" class="text-sm font-bold"></h4><button onclick="stepMonth(1)"><i data-lucide="chevron-right"></i></button></div><div id="cal-grid" class="grid grid-cols-7 gap-1"></div></div></div>

    <script>
        const State = {
            logs: JSON.parse(localStorage.getItem('jn_logs_v15') || '[]'),
            tags: JSON.parse(localStorage.getItem('jn_tags_v15') || '["深度工作", "专注阅读", "休憩发呆", "身体律动", "日常琐事"]'),
            key: localStorage.getItem('jn_key_v15') || '',
            onboarding: localStorage.getItem('jn_ob_v15') === 'true',
            tour: localStorage.getItem('jn_tour_v15') === 'true',
            date: new Date(), activeTab: 'record', statsDim: 'week', statsValue: 'this', tagSelected: ''
        };

        const TourConfig = [
            { tab: 'record', target: 'tour-date-target', text: '选择日期，补录过去的时光。' },
            { tab: 'record', target: 'tour-time-target', text: '拨动滚轮，打捞刚才发生的每一刻。' },
            { tab: 'record', target: 'tour-tag-target', text: '选一个事项。可以在设置里自定义。' },
            { tab: 'history', target: 'btn-history', text: '查看你精心打捞起的时光轨道。' },
            { tab: 'stats', target: 'btn-stats', text: '生成叙事信件，深度复盘生活。' }
        ];
        let tourIdx = 0;

        window.onload = () => {
            lucide.createIcons(); initUI(); goTab('record');
            setTimeout(() => {
                const splash = document.getElementById('app-splash');
                splash.style.opacity = '0';
                setTimeout(() => { 
                    splash.style.display = 'none'; 
                    if (!State.onboarding) document.getElementById('app-onboarding').style.display = 'flex';
                    else if (!State.tour) startTour();
                }, 500);
            }, 1000);
        };

        function initUI() {
            updateDateHeader();
            const container = document.getElementById('settingTags');
            container.innerHTML = Array(5).fill(0).map((_, i) => `<input type="text" class="tag-inp w-full p-4 rounded-2xl bg-white border-none text-sm shadow-sm" value="${State.tags[i] || ''}" placeholder="事项 ${i+1}">`).join('');
            document.getElementById('apiKeyInp').value = State.key;
            initWheels();
        }

        function goTab(t) {
            State.activeTab = t;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${t}`).classList.add('active');
            document.querySelectorAll('.n-btn').forEach(b => b.classList.replace('text-[#81B29A]', 'text-stone-300'));
            const btn = document.getElementById(`btn-${t}`); if(btn) btn.classList.replace('text-stone-300', 'text-[#81B29A]');

            const h1 = document.getElementById('main-h1'), sub = document.getElementById('sub-h1'), dateArea = document.getElementById('date-action-area');
            if (t === 'history') { h1.innerText = "今天"; sub.innerText = "过得怎么样呢"; dateArea.style.display = 'block'; renderHistory(); }
            else if (t === 'stats') { dateArea.style.display = 'none'; updateStatsHeader(); renderStats(); }
            else if (t === 'settings') { h1.innerText = "设置"; sub.innerText = "配置实验室"; dateArea.style.display = 'block'; }
            else { h1.innerText = "刚才"; sub.innerText = "做了什么呢"; dateArea.style.display = 'block'; renderRecordUI(); setTimeout(syncWheels, 50); }
            lucide.createIcons();
        }

        function renderHistory() {
            const dS = State.date.toISOString().split('T')[0];
            const filtered = State.logs.filter(l => l.date === dS).sort((a,b)=>a.startTime.localeCompare(b.startTime));
            const container = document.getElementById('history-flow');
            if (filtered.length === 0) { container.innerHTML = `<p class="py-20 text-center text-[10px] text-stone-300 italic font-serif">时光还虚位以待。</p>`; return; }
            container.innerHTML = filtered.map(l => `
                <div class="relative flex items-center">
                    <div class="w-[85px] pr-4 text-right leading-tight"><span class="text-[10px] font-bold text-stone-400 block">${l.startTime}</span><span class="text-[8px] text-stone-200 block">~ ${l.endTime}</span></div>
                    <div class="flex-1 history-card flex justify-between items-center ml-2">
                        <div class="absolute left-[89px] w-2.5 h-2.5 rounded-full border-2 border-white bg-[#81B29A] z-10"></div>
                        <h4 class="text-sm font-bold text-stone-700">${l.tag}</h4>
                        <div class="flex space-x-0.5">${Array(Number(l.vibe)).fill(0).map(()=>`<div class="w-1 h-1 rounded-full bg-stone-100"></div>`).join('')}</div>
                    </div>
                </div>
            `).join('');
        }

        function validateTime() {
            const now = new Date(), sH = parseInt(getW('h-start')), sM = parseInt(getW('m-start')), eH = parseInt(getW('h-end')), eM = parseInt(getW('m-end'));
            if (State.date.toDateString() === now.toDateString()) {
                if (eH > now.getHours() || (eH === now.getHours() && eM > now.getMinutes())) {
                    scrollW('h-end', now.getHours()); scrollW('m-end', now.getMinutes());
                }
            }
            document.getElementById('hint-yesterday').style.opacity = (sH * 60 + sM) > (eH * 60 + eM) ? '1' : '0';
        }

        function commitGrain() {
            const tag = State.tagSelected === "OTHER" ? document.getElementById('otherInp').value : State.tagSelected;
            if(!tag) return alert("事项呢？");
            State.logs.push({ id: Date.now(), date: State.date.toISOString().split('T')[0], startTime: `${getW('h-start')}:${getW('m-start')}`, endTime: `${getW('h-end')}:${getW('m-end')}`, tag: tag, vibe: document.getElementById('vibeRange').value });
            localStorage.setItem('jn_logs_v15', JSON.stringify(State.logs)); goTab('history');
        }

        function toggleStatsMenu() { const m = document.getElementById('stats-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; if(m.style.display==='block') renderStatsMenu(); }
        function setStatsDim(dim) { State.statsDim = dim; renderStatsMenu(); }
        function renderStatsMenu() {
            ['week', 'month', 'year'].forEach(d => { document.getElementById(`dim-${d}`).className = `flex-1 py-1.5 rounded-xl text-[10px] font-bold ${State.statsDim===d?'bg-white text-[#81B29A] shadow-sm':'bg-stone-100 text-stone-400'}`; });
            const list = document.getElementById('menu-options-list'); let h = ""; const now = new Date();
            if(State.statsDim === 'week') h = `<div onclick="pickStats('this')" class="menu-item ${State.statsValue==='this'?'active':''}">本周</div><div onclick="pickStats('last')" class="menu-item ${State.statsValue==='last'?'active':''}">上周</div>`;
            else if(State.statsDim === 'month') { for(let i=1; i<=12; i++) h += `<div onclick="pickStats(${i})" class="menu-item ${State.statsValue===i?'active':''}">${i}月</div>`; }
            else { for(let y=now.getFullYear(); y>=now.getFullYear()-2; y--) h += `<div onclick="pickStats(${y})" class="menu-item ${State.statsValue===y?'active':''}">${y}年</div>`; }
            list.innerHTML = h;
        }
        function pickStats(val) { State.statsValue = val; toggleStatsMenu(); renderStats(); updateStatsHeader(); }
        function updateStatsHeader() {
            const title = document.getElementById('title-area');
            let label = ""; if(State.statsDim === 'week') label = State.statsValue==='this'?"本周":"上周";
            else if(State.statsDim === 'month') label = State.statsValue + "月"; else label = State.statsValue + "年";
            title.innerHTML = `<div class="pill-toggle" onclick="toggleStatsMenu()"><span>${label}</span><i data-lucide="chevron-down" class="w-3 h-3 text-stone-300"></i></div><span class="text-sm font-medium text-stone-400 ml-2">过得怎么样呢</span>`;
            lucide.createIcons();
        }

        // --- 引导系统重构 ---
        function startTour() { tourIdx = 0; document.getElementById('tour-overlay').style.display = 'block'; document.getElementById('tour-bubble').style.display = 'block'; runTourStep(); }
        function runTourStep() {
            const step = TourConfig[tourIdx]; if (State.activeTab !== step.tab) goTab(step.tab);
            setTimeout(() => {
                const target = document.getElementById(step.target);
                document.querySelectorAll('.tour-highlight-area').forEach(el => el.classList.remove('tour-highlight-area'));
                if(target) target.classList.add('tour-highlight-area');
                document.getElementById('tour-txt').innerText = step.text; document.getElementById('tour-num').innerText = `${tourIdx + 1}/${TourConfig.length}`;
                const rect = target.getBoundingClientRect(), bubble = document.getElementById('tour-bubble');
                if (window.innerHeight - rect.bottom > 220) { bubble.style.top = (rect.bottom + 25) + 'px'; bubble.style.bottom = 'auto'; } 
                else { bubble.style.bottom = (window.innerHeight - rect.top + 25) + 'px'; bubble.style.top = 'auto'; }
                bubble.style.left = '50%'; bubble.style.transform = 'translateX(-50%)';
            }, 200);
        }
        function nextStep() { tourIdx++; if(tourIdx < TourConfig.length) runTourStep(); else { 
            document.getElementById('tour-overlay').style.display='none'; document.getElementById('tour-bubble').style.display='none'; 
            document.querySelectorAll('.tour-highlight-area').forEach(el => el.classList.remove('tour-highlight-area'));
            State.tour = true; localStorage.setItem('jn_tour_v15', 'true'); goTab('record');
        }}

        // --- 通用 ---
        function initWheels() {
            const h = Array.from({length:24},(_,i)=>i.toString().padStart(2,'0')), m = Array.from({length:60},(_,i)=>i.toString().padStart(2,'0'));
            ['h-start', 'h-end', 'm-start', 'm-end'].forEach(id => {
                const el = document.getElementById(id); const d = id.includes('h')?h:m;
                el.innerHTML = '<div class="picker-item"></div>' + d.map(v => `<div class="picker-item">${v}</div>`).join('') + '<div class="picker-item"></div>';
                el.onscroll = () => { Array.from(el.children).forEach((it, i) => it.classList.toggle('selected', i === Math.round(el.scrollTop/30) + 1)); validateTime(); };
            });
        }
        function syncWheels() { const now = new Date(); scrollW('h-end', now.getHours()); scrollW('m-end', now.getMinutes()); scrollW('h-start', (now.getHours()-1+24)%24); scrollW('m-start', now.getMinutes()); }
        function scrollW(id, v) { const el = document.getElementById(id); if (el) el.scrollTo({ top: v * 30 }); }
        function getW(id) { const el = document.getElementById(id); return el.children[Math.round(el.scrollTop/30)+1].innerText; }
        function renderRecordUI() { const box = document.getElementById('tagBox'); box.innerHTML = State.tags.map(t => `<button onclick="selT(this, '${t}')" class="btn-tag shadow-sm">${t}</button>`).join('') + `<button onclick="selT(this, 'OTHER')" class="btn-tag border-dashed border-stone-200 text-stone-300">...</button>`; }
        function selT(el, t) { document.querySelectorAll('.btn-tag').forEach(b => b.classList.remove('active')); el.classList.add('active'); State.tagSelected = t; document.getElementById('otherInp').classList.toggle('hidden', t !== 'OTHER'); if(t==='OTHER') document.getElementById('otherInp').focus(); }
        function finishOnboarding() { document.getElementById('app-onboarding').style.display = 'none'; State.onboarding = true; localStorage.setItem('jn_ob_v15', 'true'); startTour(); }
        function updateDateHeader() { document.getElementById('header-date-str').innerText = State.date.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'short'}); }
        function openCal() { document.getElementById('cal-modal').style.display = 'flex'; renderCal(); }
        function stepMonth(d) { State.date.setMonth(State.date.getMonth()+d); renderCal(); }
        function renderCal() {
            document.getElementById('cal-title').innerText = `${State.date.getFullYear()}年 ${State.date.getMonth()+1}月`;
            const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
            const days = new Date(State.date.getFullYear(), State.date.getMonth()+1, 0).getDate();
            for(let d=1; d<=days; d++) { const isSel = State.date.getDate() === d; grid.innerHTML += `<div onclick="State.date.setDate(${d}); updateDateHeader(); document.getElementById('cal-modal').style.display='none'; renderHistory();" class="cal-day ${isSel?'selected':''}">${d}</div>`; }
        }
        function applySettings() { State.tags = Array.from(document.querySelectorAll('.tag-inp')).map(i => i.value).filter(v=>v); State.key = document.getElementById('apiKeyInp').value; localStorage.setItem('jn_tags_v15', JSON.stringify(State.tags)); localStorage.setItem('jn_key_v15', State.key); alert("配置已同步"); goTab('record'); }
        function renderStats() {
            const list = document.getElementById('distList'); const counts = {}; State.logs.forEach(l => counts[l.tag] = (counts[l.tag] || 0) + 1); const total = State.logs.length || 1;
            list.innerHTML = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="space-y-1"><div class="flex justify-between text-[9px] font-bold text-stone-400"><span>${k}</span><span>${Math.round(v/total*100)}%</span></div><div class="w-full h-1 bg-white/40 rounded-full overflow-hidden"><div class="h-full bg-stone-400" style="width: ${v/total*100}%"></div></div></div>`).join('');
        }
        async function getAIReport() { if(!State.key) return alert("配置 Key"); const box = document.getElementById('reportContent'); box.innerText = "打捞记忆碎片中..."; try { const res = await fetch("https://api.deepseek.com/chat/completions", { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${State.key}`}, body:JSON.stringify({model:"deepseek-chat", messages:[{role:"system",content:`根据记录写100字叙事信件给用户：${State.logs.slice(-10).map(l=>l.tag).join(',')}`}]}) }); const data = await res.json(); box.innerText = data.choices[0].message.content; } catch(e) { box.innerText = "时光不语，但生活继续。"; } }
    </script>
</body>
</html>